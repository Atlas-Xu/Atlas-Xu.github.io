---
title: HW蓝队/红军——安全评估
tags:
  - 渗透
  - 安全
description: 视频课程source：长亭安道场，有部分补充和删减。可以大致了解流程和常见情况。
abbrlink: c80b1fd6
date: 2024-04-20 23:20:00
---

# 资产梳理
## 网络资产测绘
- 定义： 网络空间资产探测就是利用一定技术手段获取目标主机的设备属性信息和应用属性信息
- 目的：通过侦察和检索资产，发现存在的薄弱点和攻击面
- 核心思路：通过先将网络IT资产进行分析建立知识库，在发生安全事时能够在最短时间内完成安全应急
- 探测方式：根据探测方式主要分为主动探测、被动探测和基于搜索引擎的非入侵式探测
- 手段： [fofa](https://en.fofa.info/)、[shodan](https://www.shodan.io/)、[zoomeye](https://www.zoomeye.hk/)等空间资产测绘引擎
- 工具：[smap](https://github.com/s0md3v/Smap)、[goby](https://gobies.org/)、[ARL](https://github.com/TophantTechnology/ARL)、[Fscan](https://github.com/shadow1ng/fscan)、[LingLong](https://github.com/awake1t/linglong)、[Kscan](https://github.com/lcvvvv/kscan)
- 关键点：域名、IP/IP段、端口扫描和服务识别、Web站点指纹、Github关键字监控、域名/IP资产监控、站点变化监控、文件泄露风险监测
### 主动探测
包括：IP存活性探测、端口/服务探测、操作系统探测、应用类型探测、别名探测、DNS探测、流量探测
#### TCP探测技术
- TCP SYN SCAN通常被称作半开放扫描，首先发送SYN到目标端口，如果：
	- 收到SYN/ACK回复，判断端口开放
	- 收到RST，判断端口关闭
	- 没有收到回复，判断端口屏蔽
- TCP CONNECT SCAN 通常被称作全开放扫描，使用系统网络API connect 向目标主机的端口发起连接，如果
	- 收到 SYN/ACK 回复，返回ACK，判断端口开放
	- 收到RST包，判断端口关闭
	- 没有收到回复，判断端口被屏蔽
- TCP FIN /Xmas/NULL SCAN通常被称作秘密扫描，发送TCP FIN包或者Xmas tree包/NULL包，如果
	- 收到RST包，判断端口关闭
	- 没有收到RST包，判断端口开放/屏蔽

#### UDP探测技术
UDP SCAN通常用于判断UDP端口情况，向目标主机的UDP端口发送探测包，如果：
- 收到 ICMP port unreachable回复，判断端口关闭
- 没有收到回复，判断端口开放/屏蔽
#### 主机软件识别
**原理**：通过TCP/IP协议栈的指纹信息来识别目标主机的操作系统信息，这主要是利用了RFC标准中，没有强制规范了TCP/IP的某些实现，于是不同的系统中TCP/IP的实现方案可能都有其特定的方式。
- FIN 识别
- DF位识别
- WINDOWS大小识别
- TTL大小识别
- ACK序号识别

#### 子域名探测
工具：Layer子域名爆破机
证书透明度——证书授权机构会将每个SSL/TLS证书发布到公共日志中。-个SSL/TLS证书通常包含域名、子域名和邮件地址。查找某个域名所属证书的最简单的方法就是使用搜索引擎搜索一些公开的CT日志。


#### 各类资产的指纹识别
**原理**：对于各类资产的指纹识别通常是基于指纹库对比实现的，实现重点在于指纹的收集。不同的资产拥有不同的指纹。常见的指纹识别方式如：
- HTTP响应中的特定Header头
- 特定URL
- 特定文件的MD5：一些网站的特定图片文件、is文件、CSS等静态文件，如favicon.ico、css、logo.ico、js等文件一般不会修改，通过爬虫对这些文件进行抓取并比对md5值
##### 资产测绘的四个方向
- 端口服务探测
- 主机系统识别
- 子域名收集
- 资产指纹识别
##### Web服务器指纹
对Web服务器的指纹识别可分为如下几个方面：
- 应用服务器：比如Tomcat、Jboss、Weblogic、Websphere等；
- 前端技术框架：比如HTML5、jquery、bootstrap、vue等;
- 服务器语言：比如PHP、Java、Ruby、Python、C#等;
- 操作系统信息：比如Linux、Win2k8、Win7、Ubuntu、Centos等;
- CDN信息：是否使用CDN，如阿里CDN、Cloudflare等;
- WAF信息：是否使用waf，如阿里云waf、长亭雷池等
##### CMS应用系统指纹
如wordpress、织梦cms、phpcms、ecshop等，重点关注曾经公开过漏洞的cms系统和比较重要的OA系统、CRM系统、Wiki.邮箱等。
##### Nmap重要的服务探测参数 `-sV`
若不使用该参数的情况下对端口进行服务探测，很大概率上会出现误报或无法识别的情况。
##### 子域名探测脚本编写思路及方式
- 字典枚举+DNS验证
- 在线接口查询
### 探测工具
#### NMAP
包括主机发现、端口扫描、版本侦测、操作系统侦测
NMAP服务探测顺序：
1. 首先进行端口扫描，默认情况下使用SYN扫描
2. 其次进行服务识别：发送探针报文，得到返回确认值，确认服务
3. 最后进行版本识别：发送探针报文，得到返回的报文信息，分析得出服务的版本
##### 常用命令
[NMAP docs](https://nmap.org/man/zh/man-briefoptions.html)
##### Namp主机识别实现
Nmap维护1个nmap-os-db数据库:存储了上千种操作系统信息，具体一点说，Nmap分别挑选一个close和open的端口，分别发送给一个经过精心设计的TCP/UDP数据包，然后根据收到返回报文，生成一份系统指纹。通过对比检测生成的指纹和nmap-os-db数据库中的指纹，来查找匹配的系统。最坏的情况下，没有办法匹配的时候,则用概率的形式枚举出所有可能的信息。
###### 识别参数
- `-O`：启用操作系统检测
- `--osscan-limit`：针对指定的目标进行操作系统检测，这个选项仅在使用-O或-A进行操作系统检测时起作用
- `--osscan-guess`；`--fuzzy`：推测操作系统检测结果
#### MASSCAN
可以自定义任意地址范围和端口范围，相比NMAP，更快一点

#### Nessus
可同时在本机和远端做渗透扫描

#### 国内指纹识别工具
- [御剑web指纹识别程序](https://www.webshell.cc/4697.html)——Windows下可用
- [Test404轻量WEB指纹识别](https://www.test404.com/post-1618.html)——Windows下可用
- [Ehole](https://github.com/EdgeSecurityTeam/EHole) ——开源软件，可自己更新指纹,
#### 国外指纹识别工具
- [WhatWeb](https://github.com/urbanadventurer/WhatWeb) ——开源的网站指纹识别软件
- [Wapplyzer](https://chromewebstore.google.com/detail/wappalyzer-technology-pro/gppongmhjkpfnbhagpmjfkannfbllamg)——游览器插件，可识别Web框架、操作系统Web服务器、变成语言等指纹
- [Whatruns](https://chromewebstore.google.com/detail/whatruns/cmkdbmfndkfgebldhnkbfhlneefdaaip)——Chrome游览器插件，和Wapplyzer类似

#### 指纹网站
- [云悉指纹识别](http://www.yunsee.cn/)——指纹库强大，但不开源，使用需积分


## 资产管理
### CMDB
#### 架构
![CMDB架构](https://data.xchub.cn/CMDB架构.png)
![CMDB架构2](https://data.xchub.cn/CMDB架构2.png)
- CMDB架构分基础设施资产层和应用资产层
- 应用层资产架构把相关的资产以应用为中心实现资产整合
- 资产及其资产的关系称之为拓扑(应用拓扑、物理拓扑)
- 资产管理方式有人工维护和自动发现两种方式
### 梳理方法
- 确定梳理工具：人为逐设备登记、资产测绘软件、流量监控设备、态势感知平台
- 确定规章制度（最难实施）：明确资产登记与更新流程，严格按照流程执行
- 摆正工作态度：先保证基础信息正确且完整，再完善其他细节上的信息，比如软件版本号、端口开放信息

### 资产重要性
- 本质上指：使用资产时的风险
- 综合ACR=影响 * （可能性 * 可检测性）
- 影响：我们可以简单地定义1到5之间的分数，对结果进行排序，例如:微小，较少，中等，重要和严重。
- 可监测性：可以评估检测到故障发生的可能性(按概率%)。得分为100%意味着您绝对可以确定您将检测到故障情况。0%意味着你根本就没有警告征兆，即使是现场设备操作人员也无法发现。
#### 等保中的分级（常用是二三级）
- 第一级：等级保护对象受到破坏后，会对公民、法人和其他组织的合法权益造成损害，但不损害国家安全、社会秩序和公共利益
- 第二级：等级保护对象受到破坏后，会对公民、法人和其他组织的合法权益产生严重损害，或者对社会秩序和公共利益造成损害，但不损害国家安全
- 第三级：等级保护对象受到破坏后，会对公民、法人和其他组织的合法权益产生特别严重损害，或者对社会秩序和公共利益造成严重损害，或者对国家安全造成损害
- 第四级：等级保护对象受到破坏后，会对社会秩序和公共利益造成特别严重损害，或者对国家安全造成严重损害
- 第五级：等级保护对象受到破坏后，会对国家安全造成特别严重损害:

### 资产关联性
- 父子关系
- 物理依赖关系
- 业务依赖关系

### 资产变更
- 对于设备资产寿命期限的理解：对于不能容忍故障的关键资产，应当在故障要发生之前，就主动性丢弃/更换。在故障发生之前，一个关键物料必须从服务中移除(更换)的时间条件称为“安全寿命期限(safe-life limit)”。这是一个该资产近乎100%的概率无故障的寿命时长
- 按寿命进行实施资产变更：对于一些寿命周期较长的设备，特别是在运营维护过程中可能存在，随机性(因为故障或其它原因)对资产更换的行为。大多数资产管理平台中都会具有“预防性维护功能，并按照每周或每月进行设备更换，这种精细化的管理策略有助于减少损失和提升安全可靠性，尤其针对一些庞大的平台系统。

# 脆弱性分析
脆弱性也可称为弱点或漏洞，是资产或资产组中存在的可能被威胁利用造成损害的薄弱环节。脆弱性一旦被威胁成功利用就可能对资产造成损害。脆弱性可能存在于物理环境、组织、过程、人员、管理、配置、硬件、软件和信息等各个方面。
## Web应用脆弱性分析
### 常见web应用安全问题的原理/危害
- *SQL注入*：拼接的SQL字符串改变了设计者原来的意图，执行了如泄露、改变数据等操作，甚至控制数据库服务器，SQL Iniection与Command injection等攻击包括在内，可能造成的危害是:篡改网页和数据，窃取核心数据，攻击数据库所在的服务器，并使之成为a主机。
- *跨站脚本攻击(XSS或CSS)*：跨站脚本(Cross-Site Scripting)是指远程WEB页面的htm!代码可以插入具有恶意目的的数据，当浏览器下载该页面，嵌入其中的恶意脚本将被解释执行，从而对客户端用户造成伤害。简称CSS或XSS。
- *CSRF跨站伪造请求攻击*：程序员开发的时候，未对相关页面进行toKen和REFERER判断，造成攻击者可构造自己的URL地址欺骗目标用户进行点击
- *越权访问*：用户对系统的某个模块或功能没有权限，通过拼接URL或Cookie欺骗来访问该模块或功能，导致黑客利用其达到查看、修改、增加、删除不属于他权限范围内的数据。
- *任意文件上传*：这种攻击方法是最直接，最有效的。上载的文件可以是病毒，特洛伊木马，恶意脚本或Webshell。
- *URL跳转*：URL跳转漏洞即未经验证的重定向漏洞，是指Web程序直接跳转到参数中的URL，或者在页面中引入了任意开发者的URL将程序引导到不安全的第三方区域，从而导致安全问题。
- *传输层保护不足*：在身份验证过程中没有使用SSL/TLS，因此暴露传输数据和会话ID，被攻击者截听，或使用过期或者配置不正确的证书。
- *登录信息提示*：用户登录提示信息会给攻击者一些有用的信息，作为程序的开发人员应该做到对登录提示信息的模糊化，以防攻击者利用登录得知用户是否存在。
- *重复提交请求*：程序员在代码中没有对重复提交请求做限制，这样就会出现订单被多次下单，帖子被重复发布。恶意攻击者可能利用此漏洞对网站进行批量灌水，致使网站瘫痪。
- *不安全的加密存储*：常见的问题是不安全的密钥生成和储存、不轮换密钥、和使用弱算法。使用弱的或者不带salt 的哈希算法来保护密码也很普遍。外部攻击者因访问的局限性很难探测这种漏洞。他们通常必须先破解其他东西以获得需要的访问。


## 服务器软件脆弱性分析
### 中间件
中间件在操作系统、网络和数据库之上，应用软件的下层，总的作用是为处于自己上层的应用软件提供运行与开发的环境，帮助用户灵活、高效地开发和集成复杂的应用软件。
常见的中间件有：tomcat、Weblogic、Jboss、Websphere、Apache、IIS、Nginx等
### 弱口令漏洞识别和分析
[SNETCracker](https://github.com/shack2/SNETCracker)
[ysoserial.net](https://github.com/pwntester/ysoserial.net)

#### Apache Tomcat
##### 弱口令攻击策略、可造成风险
Tomcat管理页面默认端口8080，可通过端口扫描探测目标端口情况，找到tomcat页面并进行弱口令登录尝试。常见的弱口令有tomcat/tomcat，admin/admin，admin/123456，root/root等。Tomcat支持在后台部署war文件，通过弱口令登录可以直接将webshell部署到web目录下并获取服务器权限。
##### 弱口令修复方法
- 编辑conf目录下的tomcat-users.xml文件，修改账号的密码为强度较高的强密码如同时包含数字大小写字母且位数大于8位，不得使用一串相同的数字或字母组成不能键盘连续序列集合。
- Tomcat设置访问白名单,编辑文件`/webapps/manager/META-INF/context.xml`,修改为你访问网段的地址或者具体的IP。

#### Weblogic
##### 弱口令漏洞识别和分析
Weblogic管理页面默认端口7001，访问目标网站/console接口即可跳转到Weblogic后台登陆页面。通过弱口令可登录后台，Weblogic支持在后台部署war文件，可以直接将webshell部署到web目录下并获取服务器权限。
##### 弱口令修复方法
- 修改账号的密码为强度较高的强密码，如同时包含数字大小写字母且位数大于8位，不得使用一串相同的数字或字母组成，不能键盘连续序列集合。
- 使用wellogic 自带的过滤器`weblogic.security.net.ConnectionFilterlmpl`。将`weblogic.security.net.ConnectionFilterlmpl`填入`connection filter`框中，并在下面的`Connection Filter Rules:`中配置过滤规则。

### 代理服务器
代理服务器的功能是代理网络用户去取得网络信息。作为连接Internet与Intranet的桥梁，在实际应用中发挥着极其重要的作用，它可用于多个目的，最基本的功能是连接，此外还包括安全性、缓存、内容过滤、访问控制管理等功能。更重要的是，代理服务器是Internet链路级网关所提供的一种重要的安全功能，它的工作主要在开放系统互联(OSI)模型的对话层。
### 运维漏洞
#### Zabbix
- Zabbix弱口令利用：Zabbix默认的口令为`Admin:zabbix`，以及存在guest密码为空，Zabbix Server可以远程在agent的机器上执行任意命令
- 建立监控项：`zabbix_get`命令调用（执行一些命令）；`system.run[command]`运行命令；这个模块是agent自带的，获取服务器shell，获取root权限。
#### Rsync漏洞（配置不当引发的问题）
Rsync(remote synchroniz)是一款实现远程同步功能的软件（873端口），它在同步文件的同时，可以报出原来文件的权限，时间，软硬链接等附加信息。*rsync默认同步时是不加密的，可使用ssh隧道的方式来进行加密同步。*
#### Mongodb漏洞（未授权访问）
在刚安装完毕的时候MongoDB都默认有一个admin数据库,此时admin数据库是空的,没有记录权限相关的信息！
##### 安全加固
1. 确保对MongoDB数据库启用了身份验证
2. 不要开放公网0.0.0.0
3. 备份机制

### 服务漏洞
#### 电子邮件服务（SMTP、POP3、IMAP）
由于邮件发件人服务器等相关内容均可伪造，域名邮箱服务会有相关的授信问题，补充参考：[使用 Gmail 身份验证防范垃圾邮件、仿冒邮件和网上诱骗邮件](https://support.google.com/a/answer/10583557)
##### 电子邮件的格式
- 信封（如`abc@163.com`）
- 内容
	- 首都（to：xxx；Subject：xxx）
	- 主体
##### 电子邮件系统组成结构
![](https://data.xchub.cn/电子邮件系统组成结构.png)
1. 和SMTP服务器建立连接，`telnet smtp.163.com 25`
2. EHLO 发件人用户名，告诉SMTP服务器发送者的用户名
3. 选择登录认证方式，一般选择的是login
4. 分别输入经过Base64编码后的用户名和密码
5. 指明邮件的发送人和收件人
6. 输入 data(数据)命令，然后编写要发送的邮件内容
7. 输入`.`表示邮件内容输入完毕
8. 输入`quit`命令断开与邮件服务器的连接

##### SMTP(Simple Mail Transfer Protocol)
SMTP协议的通信双方采用一问一答的命令/响应形式进行对话，SMTP协议分为标准SMTP协议和扩展SMTP协议，现在我们说的SMTP协议基本上都是扩展SMTP协议。
- SMTP使用TCP连接，默认端口：25、465(ssI)、587(ssI)
- SMTP存在两个端：客户端和服务器端
- SMTP客户端和服务端可以同时运行在每个邮件服务器上
- SMTP 协议中一共定义了14条命令和21种应答信息

###### SMTP通信三个阶段
![SMTP通信建立三个阶段](https://data.xchub.cn/SMTP通信建立三个阶段.png)

##### POP3(Post Office Protocal 3)
它是因特网电子邮件的第一个离线协议标准,POP3允许用户从服务器上把邮件存储到本地主机(即自己的计算机)上，同时删除保存在邮件服务器上的邮件，而POP3服务器则是遵循POP3协议的接收邮件服务器，用来接收电子邮件的。
- 默认端口：110，995（ssl）

##### IMAP(Internet message access protocol)
开启了IMAP后，您在电子邮件客户端收取的邮件仍然保留在服务器上，同时在客户端上的操作都会反馈到服务器上，如:删除邮件，标记已读等，服务器上的邮件也会做相应的动作。所以无论从浏览器登录邮箱或者客户端软件登录邮箱，看到的邮件以及状态都是一致的。
- 默认端口：143，993（ssl）

##### POP3与IMAP区别
- POP3 协议在客户端的操作不会反馈到服务器上
- IMAP 提供双向通信，客户端的操作都会反馈到服务器上
- IMAP 提供的摘要浏览功能
- IMAP 更好地支持了从多个不同设备中随时访问新邮件

#### DNS劫持漏洞
DNS(域名系统)劫持又叫域名劫持，指攻击者利用其他攻击手段，篡改了某个域名的解析结果，使得指向该域名的IP变成了另一个IP，导致对相应网址的访问被劫持到另一个不可达的或者假冒的网址，从而实现非法窃取用户信息或者破坏正常网络服务的目的。

#### 文件传输服务（FTP）
FTP漏洞主要有以下几个方面的原因：
1. FTP的数据传输未经加密，容易被中间人攻击窃取传输数据
2. FTP服务端存在溢出漏洞，攻击者可以利用该漏洞远程执行命令
3. FTP服务端存在目录遍历漏洞，攻击者可以通过该漏洞窃取FTP服务器上的敏感数据
4. FTP服务端存在拒绝服务漏洞，攻击者可以通过该漏洞造成服务器宕机，影响FTP服务的可用性

##### FTP漏洞的风险
1. FTP服务器上存储的数据可能存在泄露的风险，黑客可以利用FTP漏洞窃取FTP服务器上的敏感数据。
2. FTP服务可能被滥用，黑客可以利用FTP服务器进行恶意攻击，入侵其他主机。
3. FTP服务器可能会被攻击者作为跳板，远程执行恶意攻击，对其他主机造成影响。
##### FTP漏洞攻击
1. FTP暴力破解攻击：通过利用暴力破解工具，对FTP服务器的用户名和密码进行猜测，入侵FTP服务器。
2. FTP漏洞利用攻击：利用FTP服务端存在的漏洞，执行攻击代码，窃取服务器上的敏感数据。
3. FTP中间人攻击：通过窃取FTP服务器的传输数据，对数据进行篡改或者劫持，以达到控制敏感信息的目的。

##### FTP漏洞修复
1. 升级FTP软件：及时更新FTP软件补丁，修复漏洞，提高FTP软件的安全性。
2. 加强FTP服务器的安全管理：定期备份FTP数据，建立安全审计机制，及时发现故障和风险。
3. 限制FTP服务的访问权限：严格限制FTP服务的访问权限，避免未授权的访问。

#### RPC
RPC漏洞入侵现象 RCP漏洞被攻击后的主要表现如下：
1. 系统资源占用率较大，CPU一直处在98%以上，并且系统中也没有运行什么较大的程序。
2. 系统弹出【系统关机】对话框，并且系统反复重启，有时也会出现在IE中不能打开新窗口、不能进行复制、粘贴等现象。

#### SNMP
SNMP 被设计为工作在TCP/IP协议族上。SNMP基于TCP/IP协议工作，对网络中支持SNMP协议的设备进行管理。所有支持SNMP协议的设备都提供SNMP这个统一界面，使得管理员可以使用统一的操作进行管理，而不必理会设备是什么类型、是哪个厂家生产的。
##### 常见漏洞
- 默认或弱SNMP团体字符串
	- 许多网络设备在出厂时设置了默认的团体字符串，如`public`和`private`
- SNMP版本漏洞
	- SNMPv1和SNMPv2c使用明文传输团体字符串，容易被网络探器截获
##### 防范措施
1. 更改默认团体字符串
2. 限制SNMP访问权限
3. 升级到SNMPv3

## 常见数据库脆弱性分析

# 网络架构和攻击面分析

# 基线评估


---
title: HW蓝队/红军——安全检测和应急（in updating）
tags:
  - 渗透
  - 安全
description: 视频课程source：长亭安道场，有部分补充和删减。
abbrlink: '97578545'
date: 2024-05-27 23:52:00
---
# Windows事件分析基础
## Windows日志
### 事件日志分析
- 对于Windows事件日志分析，不同的EVENTID代表了不同的意义，每个成功登录的事件都会标记一个登录类型，不同登录类型代表不同的方式。
- 运行eventvwr.msc命令，打开windows日志，将所有事件另存为`.evtx`格式的文件，然后通过命令进行筛选查找日志
#### 案例——利用eventlog事件来查看系统账号登录情况
1. 在“开始”菜单上，依次指向“所有程序”、“管理工具”，然后单击“事件查看器”
2. 在事件查看器中，单击“安全”，查看安全日志;
3. 在安全日志右侧操作中，点击“筛选当前日志”，输入事件ID进行筛选(ID:4625--登录失败)。
4. 可用Log Paeser分析
## 系统账号分析
### 影子账户
- 告警发生场景：黑客在入侵系统后常常会建立一个影子账户。之所以称其为“影子账户”，是因为这种账户用系统中提供的工具或方法都无法看到，并且无论是“用户账户”、“计算机管理”，还是命令行中，都无法删除此账户
- 攻击方式：攻击者获得管理员权限后，通过注册表或REG命令添加影子账户
- 复现过程：通过命令行新建一个用户(注意：新建的用户名建议以$结尾)
#### 影子账户添加
- 找到对应注册表的值：`HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\cmd$`
- 导出`reg export HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\cmd$cmd.reg`
- 默认情况下，管理员账户Administrator对应的注册表键值为`HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\000001F4`
- 然后再导出默认administrator为admin.reg `reg export HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\000001F4 administrator.reg`
- 将注册表项`HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\000003EC`下键F的值替换为`HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\000001F4`下键F的值，即`clo.reg`中键F的值替换admin.reg中键F的值
#### 影子账户检测
可以通过人工查看原始的系统日志和进入注册表编辑器进行分析，或者通过日志审计工具解析原始日志，分析出有短时间内添加账号删除账号的行为，并通过对注册表修改情况，以及跟踪未知账号后续产生的风险行为，来进行告警。
## 网络通信与异常端口分析
- **告警发生场景**：黑客在入侵系统后常常会建立一个影子账户。之所以称其为“影子账户”，是因为这种账户用系统中提供的工具或方法都无法看到。
- **攻击方式**：攻击者获得管理员权限后，通过注册表或REG命令添加影子账户
- **复现过程**：通过命令行新建一个用户（注意:新建的用户名建议以$结尾）
## 网络通信与异常端口
- 一般地可以把入侵检测技术划分为两类:误用检测和异常检测。由于误用检测需要将接收到的数据包和已知攻击的特征进行比对，因此对未知的攻击行为无法做出判断。（相当于根据特征做正则匹配，容易绕过）
- 一种网络流量异常检测系统，其特征在于，该检测系统至少包括：存储器、数据包处理单元和数据挖掘单元
- 存储器，用于储存协议会话状态机和会话状态跟踪表;所述协议会话状态机为传输控制协议TCP会话状态机、用户数据报协议UDP会话状态机或者互联网控制消息协议ICMP会话状态机；
- 数据包处理单元，与所述存储器连接，用于接收数据包，判断数据包类 型并利用存储器中存储的协议会话状态机对所述数据包所属的会话或伪会话 行为的正常程度进行度量；所述对数据包所属的会话或伪会话行为的正常程度进行度量包括：对所述会话状态跟踪表中的错误计数值进行统计，将统计后的错误计数值作为会话或者伪会话行为的正常程度的度量；
- 数据挖掘单元，与所述数据包处理单元连接，根据度量结果并利用数据 挖掘来判断所述数据包所属的会话或伪会话是否为异常
![](https://data.xchub.cn/netstat命令解析.png)
## 系统进程分析
- Windows cmd查看 `tasklist /svc`
- [ProcessMonitor](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon)
### DLL劫持
dll文件的搜索顺序为：同目录下`C:\Windows\System32`→`C:Windows\SysWow64`->`C:\Windows`->PATH路径清单

调用DLL的函数可以替换为恶意代码

## 启动项、定时任务、服务分析
## 启动项
1. 查看开机启动有无异常文件 msconfig
2. win10 win11 开机启动文件夹`C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp`
3. win7 开机启动文件夹`C:\Users\rpkr\AppData\Roaming\MicrosoftWindows\Start Menu\Programs\Startup`，开始→所有程序→启动，03查找同此方法
## 定时任务
- 查看Windows 计划任务 taskschd.msc
- 可以通过右键属性查看其位置来看看是否为正常的任务
## 服务分析
- 在比较旧的系统，我们可以通过sc来对服务进行查询，比如查询msdtc服务

## Windows注册表分析
- 注册表是用于存储Windows系统用户，硬件和软件的存储配置信息的数据库虽然注册表是为了配置系统而设计的，但它可以跟踪用户的活动，连接到系统的设备，什么时间什么软件被使用过等都将被记录在案。所有这些都可用于取证人员，分析溯源用户的恶意或非恶意行为
- 注册表由键、子键和值项构成，一个键就是分支中的一个文件夹，而子键就是这个文件夹中的子文件夹，子键同样是一个键。一个值项则是一个键的当前定义，由名称、数据类型以及分配的值组成。一个键可以有一个或多个值，每个值的名称各不相同，如果一个值的名称为空，则该值为该键的默认值。通常，值是0或1，意味着开或关，也可以包含通常以十六进制显示的更复杂的信息

# Linux事件分析基础
## Linux日志
- Linux日志默认存放位置：`/var/log`
- 查看日志配置情况：`more /etc/rsyslog.conf`
### 常用日志

| 功能     | 路径                 | 对应Linux命令          |
| ------ | ------------------ | ------------------ |
| 登录失败记录 | `/var/log/btmp`    | lastb              |
| 最后一次登录 | `/var/log/lastlog` | lastlog            |
| 登录成功记录 | `/var/log/wtmp`    | last               |
| 登录日志记录 | `/var/log/secure`  |                    |
| 登录用户信息 | `/var/run/utmp`    | w、who、users        |
| 历史命令记录 | `/history`         | 仅清理当前用户：history -c |

| 日志文件             | 说明                                                                                |
| ---------------- | --------------------------------------------------------------------------------- |
| /var/log/cron    | 记录了系统定时任务相关的日志                                                                    |
| /var/log/cups    | 记录打印信息的日志                                                                         |
| /var/log/dmesg   | 记录了系统在开机时内核自检的信息，也可以使用dmesg命令直接查看内核自检信息                                           |
| /var/log/mailog  | 记录邮件信息                                                                            |
| /var/log/message | 记录系统重要信息的日志。这个日志文件中会记录Linux系统的绝大多数重要信息，如果系统出现问题时，首先要检查的就应该是这个日志文件                 |
| /var/log/btmp    | 记录错误登录日志，这个文件是二进制文件，不能直接vi查看，而要使用lastb命令查看                                        |
| /var/log/lastlog | 记录系统中所有用户最后一次登录时间的日志，这个文件是二进制文件，不能直接vi，而要使用lastlog命令查看                            |
| /var/log/wtmp    | 永久记录所有用户的登录、注销信息，同时记录系统的启动、重启、关机事件。同样这个文件也是一个二进制文件，不能直接vi，而需要使用last命令来查看          |
| /var/log/utmp    | 记录当前已经登录的用户信息，这个文件会随着用户的登录和注销不断变化，只记录当前登录用户的信息。同样这个文件不能直接vi，而要使用w,who,users等命令来查询 |
| /var/log/secure  | 记录验证和授权方面的信息，只要涉及账号和密码的程序都会记录，比如SSH登录，su切换用户，sudo授权，甚至添加用户和修改用户密码都会记录在这个日志文件中     |
### 日志分析技巧
1. `/var/log/secure`
	1. 定位有多少IP正在爆破主机的root账号：`grep "Failed password for root" /var/log/secureawk '{print $11}'sort |uniq -c |sort -nr| more`
	2.  定位有哪些IP在爆破：`grep "Failed password" /var/log/securelgrep -E-o“(25[0-5]|2[0-4][0-9][01]?[0-9][0-9]?)\.(25[0-5]12[0-4][0-9][01]?[0-9][0-9]?)\.(25[0-5]2[0-4][0-9][01]?[0-9][0-9]?)\.(25[0-5]12[0-4][0-9][01]?[0-9][0-9]?)"uniq -c`
2. `/var/log/yum.log`
	1. 软件安装升级卸载日志
	2. `more /var/log/yum.log`
## 系统账号分析
- Linux的系统中在`/etc/passwd`文件，存储了系统中所有用户(包括系统及自建用户)的基本信息，里面的所有用户对该文件都有读的权限
- 在文件中，一行代表一个用户信息，其中每一列用冒号进行字段划分
- 用户名：密码：UID（用户ID）：GID（组ID）：描述性信息：主目录：默认命令解释器
### 影子文件
- 用于存储用户密码的文件，位于`/etc/shadow`
- shadow文件也是每一行保存一个用户信息，利用冒号作为一列的信息划分
- 用户名：加密密码：最后一次修改时间：最小修改时间间隔：密码有效期：密码需要变更前的告警天数：密码过期后的宽限时间：账号失效时间：保留字段
### authorized_keys文件
一般我们可以使用ssh-keygen命令生成公钥与私钥,运行之后将在自己的主目录下的.ssh目录生成公私钥文件，我们将id rsa.pub中的字符串复制到需要登录的主机上的对应的authorized keys即可以实现免密登录(前提是ssh配置文件开启了PubkeyAuthentication，密码认证需要开启PasswordAuthentication)
### 分析常见思路
通常，我们拿下一台机器之后想做一些权限维持，或者利用一些可读写文件的漏洞想要进一步获取服务器权限时，可以通过添加账户或者修改对应账户的authorized keys来进行实现,通常情况下，攻击者所维持权限的账户基本为高权限账户
### 排查思路
1. 查看`/etc/passwd`文件的修改时间，是否存在不在预期内的账号
2. 查看存在可登录列表的账户的目录下的.ssh中的authorized keys或者`/etc/shadow`是否有改动痕迹，值是否处于预期内
3. 查看账户的当前或者历史登录记录，是否存在可疑ip等
### 系统账号事件分析
- 查询UID为0的特权账户：`awk -F:'$3==0{print$1}'/etc/passwd`（应当只返回root）
- 查询可远程登录的账户：`awk'八\$11\$6/{print $1}'/etc/shadow`
- 查询具有sudo权限的账户：`more /etc/sudoers grep -v "^#\|^$" | grep "ALL=(ALL)"`.
- 查看敏感文件的修改时间：`stat 文件名`，不要用`ls -al`，因为Access和modify都是可以被修改的，Change时间一般跟随系统
- 使用w命令可查看当前用户的登录信息，来源ip
- 使用last命令查看历史登录的用户，来源IP等，查看成功的IP中是否有不在预期的IP地址。使用lastb命令查看历史登录失败的用户名及来源IP，观察存在较多失败记录的一些IP可判断是否遭受了暴力破解
- 当我们发现存在被他人恶意创建或者修改的账户时，在不影响业务情况下我们可以首先将该机器进行下线，然后对整个机器做入侵分析的排查。对于账户而言我们可以对其进行修改密码(passwd 用户名)，禁用账号(usermod-L用户名)，删除账号(userdel用户名。-r参数可连带删除home下该用户目录)
## 网络通信与异常端口分析
### 分析网络通信
- 如上，当我们使用命令参数进行查看时，此时可以分析当前建立连接进程及端口都有哪些。
- 我们可以根据上述连接进程来分析该进程对应的地址及程序是否合法
- 我们可以使用一些威胁情报查询工具查询该IP是否存在异常
- 若异常我们可以进行分析，可以看到，本地机器的 10.0.0.17与101.89.29.54建立了网络连接并处于连接状态
- 此时我们可以使用`ls -al(file)/proc/$PID/exe`来进行查看对应PID执行进程的文件
### 查看路由表
- 使用arp -a命令查看路由表
- 通常我们仅有在局域网中常用连接的地址才会在路由表中而当表中出现大量有顺序的一些记录时，可怀疑该机器是否被利用来进行过内网扫描
## 系统进程分析
### 系统进程
在排查的过程中，我们通过系统中所有正在运行的进程，通过输出的结果来判断系统运行的服务，从而判断是否有非法服务。使用ps命令
### 隐藏进程
目前部分攻击者可能会使用LD PRELOAD来劫持系统函数从而达到隐藏进程的目的
## 启动项、定时任务、服务分析
### 启动项
- 当我们进行开机重启等操作时，一些系统进程肯定是会更随着进行自启动才能满足机器正常使用
- `/etc/rc.d/rc.local`配置文件，当我们每次开机时，系统就会去执行该配置文件中的命令，从而使得我们预期想使用的程序在开始就进行自启动，而攻击者如果想做权限维持时，就可以像该文件中输入恶意命令，从而对我们的机器进行持久化控制
- 老版本Linux：`chkconfig --list`
- 新版本Linux：`systemctl list-unit-files--type=service lgrep "enabled"`
### 定时任务
at命令
### 计划任务
crontab
## 文件分析
### 排查文件
1. 近期内有更新过的文件
	1. 查找24h内有过更新的jsp文件：`find ./-mtime 0 -name “*.jsp'`
	2. 查找72h内有过更新的jsp文件：`find ./-ctime 2 -name “*.jsp'`
2. 一些相较敏感的文件：查看相应用户.bash history文件，若攻击者未进行清理记录或者未进行unset历史记录，可以通过文件判断攻击者执行了什么命令操作。查看常见的tmp的各个目录下是否存在一些新增的可疑文件
3. 系统文件：比如`/usr/bin`,`/usr/local/bin`等一些常见的系统文件是否被攻击者替换成了后门文件如我们常听说的ls后门，ssh后门
4. 其他文件：应用日志等
### webshell分析
- 尽可能的多关注近期存在改动的文件，如果有备份的话可以使用对比的方式查看变动或者新增的文件名，如果选择了webshell进行落地很快就可以比对
- 若我们排查的服务器上存在web的情况下，我们一般都会先对相应的web目录进行webshell查杀
- [河马](https://www.shellpub.com/doc/hm linux usage.html)、[牧云](https://github.com/chaitin/cloudwalker)
### 内存马
- 对于JSP的一些应用，现在的攻击者经常会用内存马的方式来进行权限维持且隐蔽性较高，在没有什么可疑行为的时候基本不会被发现。当然flask等也有内存马，这里不做具体讨论。
- 当我们怀疑该服务器遭受攻击需要排查时，java的内存马一般分三类：servlet-api，spring类，javainstrumentation类
- Filter/Servlet型：https://github.com/cOny1/java-memshell-scanner
- 主要通过遍历系统中servlet/filter的名称来找到相应的类，判断该类是否在服务器上能否找到对应的路径，如果找不到大概率存在异常
### 系统命令排查
`rpm -Va` 使用该命令可以进行判断是否有系统命令被替换其主要是通过判断和rpm上相应的系统的文件或者命令存在不一致的地方(ubuntu为`dpkg -V`)
### 查看输出
`SM5....T.c/etc/rc.d/rc.local`，正常的前缀可能会输出`….…...T`，或者就不进行输出，那么其出现了就说明了该文件在我们使用的过程中已经发生了改变
## 其他分析项
### 工具分析
- Rookit检测(主要检测通过修改操作系统内核或更改指令执行路径,来达到隐藏目的恶意程序)
- [rkhunter](http://rkhunter.sourceforge.net/)是一款开源入侵检测工具，具有非常全面的扫描范围，除了能够检测各种已知的 rootkit 特征码以外，还支持端口扫描、常用程序文件的变动情况检查。
- [chkrootkit](http://www.chkrootkit.org/download/)检查过程中使用了部分系统命令，如果服务器被攻击，那么依赖的系统命令可能被替换。可事先将chkrootkit使用的系统命令进行备份。

# Web日志
## 服务器日志
- 记录服务器接收客户端的请求，并记录服务器对这条请求的处理结果
- 服务器日志由服务器自动生成，一般以日期进行命名，通常以“.log”结尾
- 默认情况下IIS日志目录为`%SystemDrive%\inetpub\logs\LogFiles`其中`%SystemDrive%` 表示系统安装位置。
- Apache日志
	- Windows：`<Apache安装目录>\logs\access.log | error.log`
	- Linux：`/usr/local/apache/logs/access_logerror_log`
	- 访问日志access_log记录了所有对Web服务器的访问活动，下面是访问日志access_log中的一个标准记录。
- nginx日志
	- Nginx日志主要分为两种：access_log(访问日志)和error_log(错误日志)。通过访问日志我们可以得到用户的IP地址、浏览器的信息，请求的处理时间等信息。错误日志记录了访问出错的信息，可以帮助我们定位错误的原因。
	- Windows：`<Nginx安装目录>\logs\access.log | lerror.log`
	- Linux：`/usr/local/nginx/logs/access_log | error_log`
	- nginx日志格式可以配置多种，使用时，只需要调用相应格式名字即可
## 数据库日志
常见的数据库攻击包括弱口令、SQL注入、提升权限、窃取备份等。对数据库日志进行分析，可以发现攻击行为，进一步还原攻击场景及追溯攻击源。
### MSSQL
SQL注入入侵痕迹查找:在利用SQL注入漏洞的过程中，我们会尝试利用`sqlmap的--os-shell`参数取得shell，如操作不慎，可能留下一些sqlmap创建的临时表和自定义函数。
#### 检查方法
- 数据库表检查
- 检查`xp_cmdshell`等存储过程
- 结合web日志进行分析
# 流量分析
## 数据包
数据包是网络上信息传输的基本单位，因为发件人发出的每条信息都被分解成小的片段，以便能够在网络链接上轻松快速地传输。
- 数据报(Datagram)：多用于网络层以上，面向无连接的数据传输,工作过程类似于报文交换。采用数据报方式传输时，被传输的分组称为数据报。
- 数据包(Packet)：数据包是TCP/IP协议通信传输中的数据单位，处于网络层，在局域网中，“包”是包含在“帧”里的。
- 数据帧(Frame)：数据帧是数据链路层的协议数据单元，包括帧头，数据部分和帧尾。其中，帧头和帧尾包含一些必要的控制信息，比如同步信息、地址信息、差错控制信息等;数据部分则包含网络层传下来的数据，比如ip数据包。
## HTTP
### 请求头
1. Accept：浏览器可以接收的文件类型
2. Accept-Encóding：申明浏览器接收的编码方式
3. Accept-Language：浏览器申明自己接收的语言
4. Connection Connection:keep-alive、Connection:close
5. Host(发送请求时，该报头域是必需的)Host:www.baidu.com 请求报头域主要用于指定被请求资源的Internet主机和端口号，通常从HTTP URL中提取出来的
6. Referer：告诉服务器是从哪个页面链接过来的
7. User-Agent：告诉服务器，客户端的操作系统和浏览器名称&版本
### 响应报文
- 状态行
- 响应头
- 空行
- 响应体
### 状态行
格式：HTTP版本 响应状态码 响应描述
### 状态码
1. xx：指示信息一表示请求已接收，继续处理。
2. xx：成功一表示请求已经被成功接收、理解、接受。
3. xx：重定向一要完成请求必须进行更进一步的操作。
4. xx：客户端错误一请求有语法错误或请求无法实现
5. xx：服务器端错误一服务器未能实现合法的请求。
## DNS
- DNS，域名系统，将域名和IP地址做相互映射的一个分布式数据库。DNS可以使用TCP和UDP进行传输，DNS服务器公认端口是53.
- DNS报文封装在UDP数据报或TCP数据段中，然后封装在IP数据包中，最后封装成为数据链路层中的数据帧，通过物理层传输。
- DNS协议可分为:基础部分、问题部分和资源记录部分
### 基础部分
- 事务 ID：DNS 报文的 ID 标识。对于请求报文和其对应的应答报文，该字段的值是相同的。
- 问题计数：DNS 查询请求的数目。
- 回答资源记录数：DNS 响应的数目。
- 权威名称服务器计数：权威名称服务器的数目。
- 附加资源记录数：额外的记录数目(权威名称服务器对应 IP 地址的数目)
- 标志：QR|Opcode|AA|TC|RD|RA|Z|rcode
### 问题部分
- 查询名：一般为要查询的域名，有时也会是IP地址，用于反向查询。
- 查询类型：DNS查询请求的资源类型。通常为A类型，表示由域名获取对应的IP地址。
- 查询类：地址类型，通常为互联网地址，值为1
### 资源记录部分
- 域名：DNS请求的域名。
- 类型：资源记录的类型，与查询类型值一样
- 类：地址类型，与查询类值一样
- 生存时间：以秒为单位，表示资源记录的生命周期
- 资源数据常熟：资源数据的长度
- 资源数据：表示按查询段要求返回的相关资源记录的数据
## FTP
- 概念：提供将文件完整的从一个系统复制到另一个系统。FTP采用两个TCP连接来传输一个文件。同时FTP是一个应用程序。用户可以通过它把自己的PC机和世界各地运行FTP协议的服务器相连，访问服务器上的大量程序和信息。
- FTP主要作用：让用户连接上一个远程计算机(这些计算机上运行着FTP服务器程序)查看远程计算机有哪些问天，然后把这些文件从远程计算机上拷到本地计算机，或把本地计算机的文件送到远程计算机去
- 端口：FTP主要端口有2个，控制端口21，数据端口20。21传输控制命令，20传输数据主要使用的传输格式为二进制和文件传输格式，默认二进制传输格式。
### FTP传输模式
- 主动模式：数据连接时，服务器主动连接客户端
- 被动模式：数据连接时，客户端主动连接服务器
- 主动模式下，客户端被连接端口通常大于1024，容易被防火墙拦截。建议使用被动模式
### FTP协议格式
FTP控制帧由一段文本组成，一般结构为：`命令+空格+内容+\r\n`。
- 登录
	- `user 账号\r\n 登录账号`
	- `pass 密码\r\n 登录密码`
- 退出：`quit\r\n 退出`
- 操作
	- `STOR 文件名\r\n 上传文件`
	- `APPE 文件名\r\n 上传文件`，如果文件名已存在,把数据插入尾部
# 扫描
## 扫描行为
扫描行为一般分为主机扫描和端口扫描。
- 主机扫描主要是为探测网络上主机是否可达，也是网络扫描的基础。
- 端口扫描是在探测网络服务类型，并借此探寻攻击弱点
## 扫描行为的流量特征
1. 同一时间报文数量较多
2. 报文中data字段长度内容和大小在改变，且过长payload无规律
3. 可能由于工具协议实现的关系，存在大量的noresponse的请求
4. 请求数据包与对应的响应数据包内容不一样
5. 部分工具中带有隧道关键字



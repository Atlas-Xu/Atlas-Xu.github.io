---
title: 描述NGFW数据包转发流程Server-map (In Updating)
tags:
  - 网络
  - 安全
description: source：群友，往期HCIE-Security面试部分。
date: '2024-05-01 01:50:00'
abbrlink: 2fd2722
---
# 题目
描述NGFW数据包转发流程Server-map
# 思路
- NGFW数据转发三阶段
    - 查询会话表前
    - 查询会话中（重要）
    - 查询会话后
# 题干
![](https://data.xchub.cn/NFGW转发流程题干.png)
# 实战画板
## NGFW数据转发三个阶段
防火墙在收到数据包到内部处理及转发时，可以分为三个阶段，分别为查询会话表前、查询会话表中、查询会话表后；
## 查询会话表前
主要目的是解析出报文的帧头部和IP报文头部,根据头部当中的信息进行一些基础的安全检测
接收报文 → 解析帧头部 → 剥离帧头部 → 解析IP报文头 → 白名单 → DDoS攻击防范 → IP/MAC绑定
## 查询会话中（重点）
主要分为有会话和没会话两种，根据查询结果对报文做不同的安全机制检测和处理，此阶段是NGFW的核心处理环节，主要的安全功能都在这个阶段实现。
### 没会话
状态检测（1、判断是否开启状态检测；2、判断是否首包（SYN/UDP/PING）） → 黑名单 → server-map（4种类型ASPF多通道协议生成四元组（匹配策略直接生成会话表），STUN三元组，NAT（匹配安全策略才能生成） NO-PAT，NAT server） → 在线用户表 → 目的NAT（nat-server） → 路由表/MAC表 → 认证策略 → 安全策略匹配（包过滤） → SSL加密流量检测策略 → 源NAT策略 → 连接数限制 → 创建会话
### 有会话
刷新在线用户表 → 流攻击防范 → 状态检测（判断是否需要刷新会话；1、用户上下线；2、应用识别（1特征字；2关键载荷；3行为模型）；3、UTM检测黑名单；4配置变更）--否--是-》路由表/MAC表 → 安全策略匹配（包过滤） → 黑名单 → 用户重定向
## 查询会话后
对流量进行相应的安全检测处理并转发；
带宽策略 → 内容安全（AV，IPS，URL） → 报文地址转换（源NAT转换） → VPN加解封装（GRE，IPSEC，SSL，L2TP） → 入接口带宽阈值 → 出接口带宽阈值 → 发送报文
# 补充
由于在报文处理的过程中，某些特性可能会修改报文的一些字段，因此掌握这个流程图可以帮助管理员后续的配置和维护。
比如在NAT处理中，NGFW会修改IP报文的源IP地址或者目的IP地址。而在安全策略匹配以及路由表查询中，又要根据IP地址来进行规则匹配。根据图1，服务器映射在安全策略匹配和路由表查询之前处理，源NAT策略在安全策略匹配和路由表查询之后处理。
假设一条Internet用户访问内部服务器的流量，需要经过以下两次NAT转换：
1. 经过服务器映射处理，将其目的IP地址修改为服务器的私网IP地址。
2. 经过源NAT策略处理，将其源IP地址修改为与服务器在同一网段的私网IP地址
## 查询会话表前
### MAC地址过滤&解析帧头部

### 对于三层接口接收的报文

### 对于二层接口接收的报文

### 剥离帧头部
### 解析IP报文头&IP/MAC绑定&入接口IP阈值&单包攻击防范

## 查询会话表中

### 状态检测
进行状态检测机制检测，判断该报文是否属于正常的可以建立会话的首包。（这个状态检测是检查，该步骤是看防火墙是否开启了状态检测，NGFW默认是开启的，当来回路径不一致的流量要通过NGFW时，需要关闭状态检测机制，其次是查看数据包是不是首包，是首包，进行下一步骤，不是首包，丢掉）

**追问**：什么情况会导致会话来回路径不一致？
例如硬件SACG功能会导致来回路径不一致，双机热备负载分担的情况下。

对于正常首包（对于TCP包和ICMP的回显请求报文包才存在首包和非首包），NGFW将进行一系列的查询和处理，以获取这条流量的用户和应用等无法通过解析头部获取的信息。
### 黑名单
查看数据包的源地址是不是在黑名单中，如在黑名单中到此过程便被丢弃，不再进行后续流程。（生成黑名单的方式有很多种，形成方式：可以是手动添加的，或者是单包攻击防范中动态生成的，类型：源目IP 、用户；很多的排错中都可能涉及到黑名单问题）

### server-map（重点）
用于服务器映射、负载均衡和多通道协议转发的重要表项。
如果首包匹配Server-map，FW根据Server-map对报文进行转发或地址转换。Server-map分为静态Server-map和动态Server-map：
- 静态：服务器映射、负载均衡、NAT64；
- 动态：NAT No-PAT、NAT Full-cone、DS-Lite（做安全检车）、ASPF/NAT ALG（不做安全检查）

查看数据包是否匹配NGFW上现有的Server-map表
简单的说Server-map表，会有两种作用出现在两种不同情况：
1. 如果匹配的是ASPF产生的Server-map表，便直接产生会话表；
2. 如果匹配的是nat（no-pat或者nat-server只是记录转换后的目的IP和端口信息）产生的Server-map便会对数据包做地址转换，地址转换完成后进入安全策略匹配才产生会话表。其实还有SLB、三元组NAT等也会生成Server-map表；
注：由于Server-map中并不会记录报文的下一跳等信息，所以Server-map通常只是用来检查第一个报文。在这个报文通过检查之后，系统会生成一条会话表用于后续报文的转发。即Server-map只是用于新通道建立，通道建立后的报文还是根据会话表来转发。因此对于以上几种产生Server-map的情况最终也都还是会产生会话表项的。

### 目的NAT
查看数据包有没有对应的服务器映射（nat-server）数据包要先将访问的目的地址转换后才能进一步查路由表，所以这也就解释了为什么目的NAT阶段在查找路由表阶段前面。


# 追问
## policy name有几种情况？
三种，有名字、---，默认策略default
## 应用怎么识别？
开启SA功能
##  server-map老化时间?
没流量时才会老化，有流量过来直接刷新表项了
##  状态检测怎么理解？哪些报文是首包？
开启状态检测首包创建会话，syn，icmp request，udp
## 会话表和servermap表的关系？
先查server-map，再查会话表
## 没有路由会不会命中会话表？
不会命中
## 路由下一跳写错了在会话表中是怎么呈现的？
显示错误的下一跳MAC地址
## 已经生成的会话,管理员改了策略变成deny会怎么样？
会话消失
## tcp的老化时间是多少？
1200秒
## 防火墙产生的会话表是什么样的？
```
  telnet  VPN:public --> public  ID: a48f3648905d02c0553591da1
  Zone: trust--> local  TTL: 00:20:00  Left: 00:20:00
  Output-interface: InLoopBack0  NextHop: 127.0.0.1  MAC: 00-00-00-00-00-00
  <--packets:89 bytes:5174   -->packets:98 bytes:4014
  10.18.196.44:2807-->10.18.196.253:23
```
## 静态路由下一跳配置错误，是否可以完成转发？
是否有默认路由，如果没有不能完成转发。
## 如何依据session table排错定位？
看是否来回路径不一致，看显示来回包的地方，是否没有回包数据。
## 什么情况下会话表里的MAC地址为全0？
1. 当目的IP为防火墙的接口地址时（表示流量是抵达防火墙本身的），下一跳IP为127.0.0.1，MAC为全0
2. 转发到虚拟墙里的报文，下一跳MAC为全0
3. ARP请求失败时，下一跳IP的MAC为全0
## 为什么单包攻击在第一阶段最后？
单包攻击一般是基于数据链路层、IP层，必须解析帧头部和IP后才能防范，在第一阶段能及时处理单包攻击较为合理，如果放在创建会话处影响防火墙性能
## 有会话阶段的状态检测是什么意思？
检测是否需要刷新会话；用户上下线、**应用识别（1特征字；2关键载荷；3行为模型）**
## 会话表中的policyName为---代表什么意思？
没有匹配安全策略的流量，到达设备本身的报文会跳过安全策略检查

以下几种情况会遇到：
- 报文命中了认证动作为Portal认证的认证策略；
- 用户向Web服务器发起HTTP/HTTPS请求时，syn首包不受安全策略控制；
- 接口开启了网管功能；
- 双机热备，主墙备份到备墙，备墙会话表显示---；

## 什么情况下不受安全策略控制？
1. ASPF的情况
2. 开启了接口网管功能的情况

## 会话表老化方式
1. 超过老化时间后的会话老化
2. 内容安全检测出威胁后的会话老化
3. TCP会话收到FIN/RST报文后的会话老化

## 开启了状态检测，只有首包才能创建会话吗？那ESP报文能不能创建会话？.
可以，基于ip的包都可以创建，比如OSPF

## Server-Map的本质是什么？
Server-Map其实就是一张特别通行证，是ASPF的核心表项

## ASPF的本质又是什么？
ASPF本质就是识别应用层（报文载荷）中关联应用的地址和端口，并通过Server-map表项为转发建立临时会话。 

## ASPF产生几元组的server-map表？
ASPF多通道协议生成四元组(源目IP、协议、端口号)，STUN三元组（目的IP、端口、协议）

## 黑名单有什么类型？
两种，手动创建和自动创建（三种类型，源IP、目的IP、用户类型）

## 应用是怎么识别的？
特征字、关键载荷、行为模型

## 会话表构成？
![](https://data.xchub.cn/会话表构成.png)

## 建立会话第一步进行状态检测检测的是什么？
检查防火墙是否开始状态检测，判断该包是否是首包。分TCP，UDP，ICMP

## 已经有会话了是否还需要进行状态检测？如果需要检测的是什么？
需要，首包检测没问题不代表后续报文也是正常的。应用信息识别、用户上下线、内容安全功能检测出流量携带入侵或病毒等安全风险（首包没有病毒，后续报文突然包含病毒会触发该项）、管理员配置变更（例如修改安全策略中的源目的IP等）

## 为什么认证策略是在路由表下方？
认证策略前需通过路由表确定源目区域（匹配认证策略需要通过匹配4元组作为依据，4元组为源目IP，源目区域）

## Syn攻击是在上面步骤中检查出来的？什么是流攻击？
Syn是flood攻击，是在有会话时进行流攻击扫描检查。流攻击就是使用大量正常的报文来进行攻击，主要造成拒绝服务的攻击效果。

## 为什么匹配nat那里不直接进行转换？
直接转换如果遇到数据包超过连接数限制，无法创建会话表，会造成资源浪费；

## 会话老化时间是否会变化？ 
会，可以手动更改。

## 查询会话时间的命令？
`dis firewall session aging-time`

## Server-map表和后面的服务器映射表是否作用相同？有什么区别？
服务器映射，是基于命令对服务器映射关系的体现，并且基于服务器映射生成的Server-map表。
server-map，其中包含服务器映射所产生的表项，用于匹配访问对应服务的流量创建后续会话而使用。ASPF、NAT的NO-PAT，SLB都会产生server-map表项。

## 3次握手老化时间？
Syn 5秒，syn+ack 10秒。

## 为什么有了源NAT处理，在第二部分还需要进行源NAT匹配？
第二阶段会生成会话表，会话表中需要有相应的转换表项。

## 认证策略匹配条件？
源目安全区域，源目IP地址

## 为什么路由表查询是在安全策略匹配包过滤过程之前？
因为域间包过滤策略是匹配有源安全区域和目的安全区域的，要知道来的数据包源IP到目的IP是从哪个区域的只能通过查询路由表来确定的，所以检查路由表在安全策略匹配包过滤过程前面。

## 在哪些情况下会话表才会被刷新？
应用识别、内容安全功能检测查询到后续包有带病毒、配置变更（策略、路由）、用户上下线会被刷新

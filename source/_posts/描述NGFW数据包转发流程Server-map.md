---
title: 描述NGFW数据包转发流程Server-map (In Updating)
tags:
  - 网络
  - 安全
description: source：群友，往期HCIE-Security面试部分。
date: '2024-05-01 01:50:00'
abbrlink: 2fd2722
---
# 题目
描述NGFW数据包转发流程Server-map
# 思路
- NGFW数据转发三阶段
    - 查询会话表前
    - 查询会话中（重要）
    - 查询会话后
# 题干
![](https://data.xchub.cn/NFGW转发流程题干.png)
# 实战画板
## NGFW数据转发三个阶段
防火墙在收到数据包到内部处理及转发时，可以分为三个阶段，分别为查询会话表前、查询会话表中、查询会话表后；
## 查询会话表前
主要目的是解析出报文的帧头部和IP报文头部,根据头部当中的信息进行一些基础的安全检测
接收报文 → 解析帧头部 → 剥离帧头部 → 解析IP报文头 → 白名单 → DDoS攻击防范 → IP/MAC绑定
## 查询会话中（重点）
主要分为有会话和没会话两种，根据查询结果对报文做不同的安全机制检测和处理，此阶段是NGFW的核心处理环节，主要的安全功能都在这个阶段实现。
### 没会话
状态检测（1、判断是否开启状态检测；2、判断是否首包（SYN/UDP/PING）） → 黑名单 → server-map（4种类型ASPF多通道协议生成四元组（匹配策略直接生成会话表），STUN三元组，NAT（匹配安全策略才能生成） NO-PAT，NAT server） → 在线用户表 → 目的NAT（nat-server） → 路由表/MAC表 → 认证策略 → 安全策略匹配（包过滤） → SSL加密流量检测策略 → 源NAT策略 → 连接数限制 → 创建会话
### 有会话
刷新在线用户表 → 流攻击防范 → 状态检测（判断是否需要刷新会话；1、用户上下线；2、应用识别（1特征字；2关键载荷；3行为模型）；3、UTM检测黑名单；4配置变更）--否--是-》路由表/MAC表 → 安全策略匹配（包过滤） → 黑名单 → 用户重定向
## 查询会话后
对流量进行相应的安全检测处理并转发；
带宽策略 → 内容安全（AV，IPS，URL） → 报文地址转换（源NAT转换） → VPN加解封装（GRE，IPSEC，SSL，L2TP） → 入接口带宽阈值 → 出接口带宽阈值 → 发送报文
# 补充

# 追问
## policy name有几种情况？
三种，有名字、---，默认策略default
## 应用怎么识别？
开启SA功能
##  server-map老化时间?
没流量时才会老化，有流量过来直接刷新表项了
##  状态检测怎么理解？哪些报文是首包？
开启状态检测首包创建会话，syn，icmp request，udp
## 会话表和servermap表的关系？
先查server-map，再查会话表
## 没有路由会不会命中会话表？
不会命中
## 路由下一跳写错了在会话表中是怎么呈现的？
显示错误的下一跳MAC地址
## 已经生成的会话,管理员改了策略变成deny会怎么样？
会话消失
## tcp的老化时间是多少？
1200秒
## 防火墙产生的会话表是什么样的？
```
  telnet  VPN:public --> public  ID: a48f3648905d02c0553591da1
  Zone: trust--> local  TTL: 00:20:00  Left: 00:20:00
  Output-interface: InLoopBack0  NextHop: 127.0.0.1  MAC: 00-00-00-00-00-00
  <--packets:89 bytes:5174   -->packets:98 bytes:4014
  10.18.196.44:2807-->10.18.196.253:23
```
## 静态路由下一跳配置错误，是否可以完成转发？
是否有默认路由，如果没有不能完成转发。
## 如何依据session table排错定位？
看是否来回路径不一致，看显示来回包的地方，是否没有回包数据。
## 什么情况下会话表里的MAC地址为全0？
1. 当目的IP为防火墙的接口地址时（表示流量是抵达防火墙本身的），下一跳IP为127.0.0.1，MAC为全0
2. 转发到虚拟墙里的报文，下一跳MAC为全0
3. ARP请求失败时，下一跳IP的MAC为全0
## 为什么单包攻击在第一阶段最后？
单包攻击一般是基于数据链路层、IP层，必须解析帧头部和IP后才能防范，在第一阶段能及时处理单包攻击较为合理，如果放在创建会话处影响防火墙性能
## 有会话阶段的状态检测是什么意思？
检测是否需要刷新会话；用户上下线、**应用识别（1特征字；2关键载荷；3行为模型）**
## 会话表中的policyName为---代表什么意思？
没有匹配安全策略的流量，到达设备本身的报文会跳过安全策略检查

以下几种情况会遇到：
- 报文命中了认证动作为Portal认证的认证策略；
- 用户向Web服务器发起HTTP/HTTPS请求时，syn首包不受安全策略控制；
- 接口开启了网管功能；
- 双机热备，主墙备份到备墙，备墙会话表显示---；

## 什么情况下不受安全策略控制？
1. ASPF的情况
2. 开启了接口网管功能的情况

## 会话表老化方式
1. 超过老化时间后的会话老化
2. 内容安全检测出威胁后的会话老化
3. TCP会话收到FIN/RST报文后的会话老化

## 开启了状态检测，只有首包才能创建会话吗？那ESP报文能不能创建会话？.
可以，基于ip的包都可以创建，比如OSPF

## Server-Map的本质是什么？
Server-Map其实就是一张特别通行证，是ASPF的核心表项

## ASPF的本质又是什么？
ASPF本质就是识别应用层（报文载荷）中关联应用的地址和端口，并通过Server-map表项为转发建立临时会话。 

## ASPF产生几元组的server-map表？
ASPF多通道协议生成四元组(源目IP、协议、端口号)，STUN三元组（目的IP、端口、协议）

## 黑名单有什么类型？
两种，手动创建和自动创建（三种类型，源IP、目的IP、用户类型）

## 应用是怎么识别的？
特征字、关键载荷、行为模型

## 会话表构成？
![](https://data.xchub.cn/会话表构成.png)

## 建立会话第一步进行状态检测检测的是什么？
检查防火墙是否开始状态检测，判断该包是否是首包。分TCP，UDP，ICMP

## 已经有会话了是否还需要进行状态检测？如果需要检测的是什么？
需要，首包检测没问题不代表后续报文也是正常的。应用信息识别、用户上下线、内容安全功能检测出流量携带入侵或病毒等安全风险（首包没有病毒，后续报文突然包含病毒会触发该项）、管理员配置变更（例如修改安全策略中的源目的IP等）

## 为什么认证策略是在路由表下方？
认证策略前需通过路由表确定源目区域（匹配认证策略需要通过匹配4元组作为依据，4元组为源目IP，源目区域）

## Syn攻击是在上面步骤中检查出来的？什么是流攻击？
Syn是flood攻击，是在有会话时进行流攻击扫描检查。流攻击就是使用大量正常的报文来进行攻击，主要造成拒绝服务的攻击效果。

## 为什么匹配nat那里不直接进行转换？
直接转换如果遇到数据包超过连接数限制，无法创建会话表，会造成资源浪费；

## 会话老化时间是否会变化？ 
会，可以手动更改。

## 查询会话时间的命令？
`dis firewall session aging-time`

## Server-map表和后面的服务器映射表是否作用相同？有什么区别？
服务器映射，是基于命令对服务器映射关系的体现，并且基于服务器映射生成的Server-map表。
server-map，其中包含服务器映射所产生的表项，用于匹配访问对应服务的流量创建后续会话而使用。ASPF、NAT的NO-PAT，SLB都会产生server-map表项。

## 3次握手老化时间？
Syn 5秒，syn+ack 10秒。

## 为什么有了源NAT处理，在第二部分还需要进行源NAT匹配？
第二阶段会生成会话表，会话表中需要有相应的转换表项。

## 认证策略匹配条件？
源目安全区域，源目IP地址

## 为什么路由表查询是在安全策略匹配包过滤过程之前？
因为域间包过滤策略是匹配有源安全区域和目的安全区域的，要知道来的数据包源IP到目的IP是从哪个区域的只能通过查询路由表来确定的，所以检查路由表在安全策略匹配包过滤过程前面。

## 在哪些情况下会话表才会被刷新？
应用识别、内容安全功能检测查询到后续包有带病毒、配置变更（策略、路由）、用户上下线会被刷新
